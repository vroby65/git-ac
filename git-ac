#!/usr/bin/env bash

git add .

diff=$(git diff --cached)
if [ -z "$diff" ]; then
    echo "No changes to commit."
    exit 0
fi

# Try to generate a commit message with Ollama
msg=$(ollama run mistral "Write a very short git commit message from:\n$diff")

# Try to generate a commit message with tgpt and clean output: remove "Loading", empty lines, leading spaces
#raw=$(tgpt "Write ONLY a very short git commit message from:\n$diff")
#raw1=$(echo "$raw" | sed 's/.*Loading[[:space:]]*//' | sed 's/^[[:space:]]*//' )
#msg=$(echo "$raw1" | sed -n '/^```/{n;:a;/^```/q;p;n;ba}')


if [ $? -ne 0 ] || [ -z "$msg" ]; then
    echo "‚ö†Ô∏è Ollama not available, here is the diff:"
    echo
    echo "$diff"
    echo
    read -p "Write the commit message manually: " msg
fi

while true; do
    echo
    echo "üí° Proposed commit message:"
    echo "\"$msg\""
    echo
    read -p "Confirm commit? [Y/n/e] " choice
    choice=$(echo "$choice" | tr '[:upper:]' '[:lower:]')

    case "$choice" in
        ""|"y")
            git commit -m "$msg"
            echo "‚úÖ Commit completed."
            break
            ;;
        e)
            tmp=$(mktemp)
            echo "$msg" > "$tmp"
            git commit --dry-run -m "$msg" > /dev/null 2>&1
            ${EDITOR:-nano} "$tmp"
            msg=$(cat "$tmp")
            rm "$tmp"
            # back to loop
            ;;
        n|*)
            echo "‚ùå Commit canceled."
            break
            ;;
    esac
done
